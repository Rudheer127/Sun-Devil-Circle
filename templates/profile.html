{% extends "base.html" %}

{% block title %}Profile Settings - SunDevil Circle{% endblock %}

{% block content %}
<div class="container" style="padding-top: 140px; padding-bottom: 80px; max-width: 800px;">

    <!-- Breadcrumb -->
    <nav style="margin-bottom: 24px;">
        <a href="{{ url_for('decision') }}" style="color: var(--text-secondary); font-size: 14px;">‚Üê Dashboard</a>
        <span style="color: var(--text-light); margin: 0 8px;">‚Ä∫</span>
        <span style="color: var(--text-primary); font-size: 14px; font-weight: 500;">Profile Settings</span>
    </nav>

    <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Profile Settings</h1>
    <p style="color: var(--text-secondary); margin-bottom: 32px;">Manage your profile and preferences</p>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}"
        style="margin-bottom: 24px; padding: 16px 20px; border-radius: 12px; background: {{ '#D1FAE5' if category == 'success' else '#FEE2E2' }}; color: {{ '#065F46' if category == 'success' else '#991B1B' }};">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('profile') }}" id="profileForm">
        <!-- Profile Avatar Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üë§</span> Your Identity
            </h2>

            <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
                <div id="avatarPreview"
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, #8B1538, #A91D3A); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; font-weight: 700;">
                    {{ profile.display_name[0].upper() if profile and profile.display_name else '?' }}
                </div>
                <div>
                    <p style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">{{ profile.display_name
                        if profile else 'Anonymous' }}</p>
                    <p style="font-size: 14px; color: var(--text-secondary);">Member since {{ session.get('created_at',
                        'recently') | default('recently') }}</p>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="display_name">Display Name</label>
                <div style="display: flex; gap: 12px;">
                    <input type="text" id="display_name" name="display_name" class="form-input" style="flex: 1;"
                        placeholder="Choose a display name" required maxlength="30"
                        value="{{ profile.display_name if profile else '' }}">
                    <button type="button" onclick="generateRandomName()" class="btn btn-outline"
                        style="white-space: nowrap;">
                        ‚ú® Random
                    </button>
                </div>
                <p class="sticky-note" style="margin-top: 12px;">
                    üí° Your display name is how others will see you. You can use any name to protect your privacy.
                </p>
            </div>
        </div>

        <!-- Account Info Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üìß</span> Account Information
            </h2>

            <div class="form-group">
                <label class="form-label">Username</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="text" class="form-input" value="{{ session.get('username', '') }}" disabled
                        style="flex: 1; background: #F9FAFB;">
                    <span style="font-size: 12px; color: var(--text-light);">Cannot be changed</span>
                </div>
            </div>
        </div>

        <!-- Support Preferences Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üéØ</span> Support Topics
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">What would you like to
                discuss? Select all that apply.</p>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                {% set topics = [
                ('homesickness', 'üè†', 'Homesickness'),
                ('loneliness', 'üí≠', 'Loneliness'),
                ('anxiety', 'üò∞', 'Anxiety'),
                ('culture_shock', 'üåç', 'Culture Shock'),
                ('academics', 'üìö', 'Academics'),
                ('relationships', 'üíï', 'Relationships'),
                ('identity', 'ü™™', 'Identity'),
                ('finances', 'üí∞', 'Finances')
                ] %}
                {% for value, icon, label in topics %}
                <label class="checkbox-card"
                    style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 14px 16px; background: #FAFAFA; border-radius: 12px; border: 2px solid transparent; transition: all 200ms;">
                    <input type="checkbox" name="support_topics" value="{{ value }}" {{ 'checked' if profile and value
                        in (profile.support_topics or []) else '' }}
                        style="width: 18px; height: 18px; accent-color: var(--primary-maroon);">
                    <span style="font-size: 20px;">{{ icon }}</span>
                    <span style="font-weight: 500;">{{ label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Language Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üåê</span> Language & Communication
            </h2>

            <div class="form-group">
                <label class="form-label">Languages you speak</label>
                <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 14px;">Select all languages
                    you're comfortable chatting in.</p>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% set languages = ['English', 'Spanish', 'Mandarin', 'Hindi', 'Arabic', 'Portuguese', 'French',
                    'Korean', 'Japanese', 'Vietnamese', 'Tagalog', 'Other'] %}
                    {% for lang in languages %}
                    <label class="language-pill"
                        style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border: 2px solid #E5E7EB; border-radius: 20px; cursor: pointer; transition: all 200ms; background: white;">
                        <input type="checkbox" name="languages" value="{{ lang }}" {{ 'checked' if profile and lang in
                            (profile.languages or []) else '' }} style="display: none;">
                        <span>{{ lang }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
                <label class="form-label">Support Style</label>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% set styles = [
                    ('listening', 'Just listening', 'I prefer someone who listens without giving advice'),
                    ('advice', 'Advice welcome', 'I appreciate suggestions and guidance'),
                    ('mixed', 'Mixed approach', 'Sometimes listening, sometimes advice')
                    ] %}
                    {% for value, title, desc in styles %}
                    <label class="radio-card-input"
                        style="display: flex; align-items: center; gap: 16px; cursor: pointer; padding: 16px; background: #FAFAFA; border-radius: 12px; border: 2px solid transparent; transition: all 200ms;">
                        <input type="radio" name="support_style" value="{{ value }}" {{ 'checked' if (profile and
                            profile.support_style==value) or (not profile and value=='mixed' ) else '' }}
                            style="width: 20px; height: 20px; accent-color: var(--primary-maroon);">
                        <div>
                            <strong style="display: block; margin-bottom: 2px;">{{ title }}</strong>
                            <span style="font-size: 14px; color: var(--text-secondary);">{{ desc }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Cultural Background Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üåè</span> Cultural Background
                <span style="font-size: 12px; color: var(--text-light); font-weight: 400;">(Optional)</span>
            </h2>

            <div class="form-group">
                <label class="form-label">Region</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    {% set cultures = ['East Asia', 'South Asia', 'Southeast Asia', 'Middle East', 'Africa', 'Europe',
                    'Latin America', 'North America', 'Pacific Islands'] %}
                    {% for culture in cultures %}
                    <label class="culture-pill"
                        style="display: inline-flex; align-items: center; padding: 8px 16px; border: 2px solid #E5E7EB; border-radius: 20px; cursor: pointer; transition: all 200ms; background: white;">
                        <input type="checkbox" name="cultural_background" value="{{ culture }}" {{ 'checked' if profile
                            and culture in (profile.cultural_background or []) else '' }} style="display: none;">
                        <span>{{ culture }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
                <label class="form-label">Are you an international freshman?</label>
                <div style="display: flex; gap: 16px; margin-top: 8px;">
                    <label
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: #FAFAFA; border-radius: 8px;">
                        <input type="radio" name="is_international_freshman" value="yes" {{ 'checked' if profile and
                            profile.is_international_freshman else '' }} style="accent-color: var(--primary-maroon);">
                        <span>Yes</span>
                    </label>
                    <label
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: #FAFAFA; border-radius: 8px;">
                        <input type="radio" name="is_international_freshman" value="no" {{ 'checked' if profile and not
                            profile.is_international_freshman else '' }} style="accent-color: var(--primary-maroon);">
                        <span>No</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Saved Resources Section -->
        <div class="card" style="margin-bottom: 24px;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">üìö</span> Resources
            </h2>

            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{{ url_for('resources') }}" class="btn btn-outline">View All Resources</a>
            </div>
        </div>

        <!-- Account Actions -->
        <div class="card" style="margin-bottom: 24px; border: 2px solid #FEE2E2;">
            <h2
                style="font-size: 18px; font-weight: 600; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: #991B1B;">
                <span style="font-size: 24px;">‚öôÔ∏è</span> Account Actions
            </h2>

            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="{{ url_for('logout') }}" class="btn"
                    style="background: #FEE2E2; color: #991B1B; border: none;">Sign Out</a>
            </div>
        </div>

        <!-- Save Button -->
        <div
            style="position: sticky; bottom: 24px; background: white; padding: 16px; border-radius: 16px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); display: flex; gap: 16px; justify-content: flex-end;">
            <a href="{{ url_for('decision') }}" class="btn btn-outline">Cancel</a>
            <button type="submit" class="btn btn-maroon" style="padding: 14px 32px; font-size: 16px;">
                üíæ Save Changes
            </button>
        </div>
    </form>
</div>

<style>
    .sticky-note {
        background: #FEF3C7;
        border: 2px solid #FBBF24;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        color: #92400E;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }

    .checkbox-card:has(input:checked) {
        background: #FFF1F2;
        border-color: var(--primary-maroon);
    }

    /* Language and Culture pills - explicit styles */
    .language-pill,
    .culture-pill {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border: 2px solid #E5E7EB;
        border-radius: 20px;
        cursor: pointer;
        transition: all 200ms;
        background: white;
        color: var(--text-primary);
    }

    .language-pill:has(input:checked),
    .culture-pill:has(input:checked),
    .language-pill.selected,
    .culture-pill.selected {
        background: var(--primary-maroon) !important;
        color: white !important;
        border-color: var(--primary-maroon) !important;
    }

    .radio-card-input:has(input:checked) {
        background: #FFF1F2;
        border-color: var(--primary-maroon);
    }
</style>

<script>
    // Random name generator
    const adjectives = ['Sunny', 'Happy', 'Brave', 'Kind', 'Wise', 'Calm', 'Bold', 'Cool', 'Swift', 'Bright'];
    const nouns = ['Phoenix', 'Cactus', 'Desert', 'Star', 'Moon', 'Sun', 'Eagle', 'Hawk', 'Fox', 'Wolf'];

    function generateRandomName() {
        const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
        const noun = nouns[Math.floor(Math.random() * nouns.length)];
        const num = Math.floor(Math.random() * 100);
        document.getElementById('display_name').value = adj + noun + num;
        updateAvatarPreview();
    }

    function updateAvatarPreview() {
        const name = document.getElementById('display_name').value;
        const preview = document.getElementById('avatarPreview');
        preview.textContent = name ? name[0].toUpperCase() : '?';
    }

    document.getElementById('display_name').addEventListener('input', updateAvatarPreview);

    // Initialize pill states immediately on page load
    function initializePills() {
        document.querySelectorAll('.language-pill, .culture-pill').forEach(pill => {
            const input = pill.querySelector('input');
            if (input && input.checked) {
                pill.classList.add('selected');
            } else {
                pill.classList.remove('selected');
            }
        });
    }

    // Toggle pills on click
    document.querySelectorAll('.language-pill input, .culture-pill input').forEach(input => {
        input.addEventListener('change', function () {
            const pill = this.closest('label');
            if (this.checked) {
                pill.classList.add('selected');
            } else {
                pill.classList.remove('selected');
            }
        });
    });

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', initializePills);
    // Also run immediately in case DOM is already ready
    initializePills();

    // Warn on unsaved changes
    let formChanged = false;
    document.getElementById('profileForm').addEventListener('change', () => {
        formChanged = true;
    });

    window.addEventListener('beforeunload', (e) => {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    document.getElementById('profileForm').addEventListener('submit', () => {
        formChanged = false;
    });
</script>
{% endblock %}