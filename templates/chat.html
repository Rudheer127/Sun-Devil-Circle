{% extends "base.html" %}

{% block title %}{{ group_topic }} - Chat - SunDevil Circle{% endblock %}

{% block content %}
<div class="container" style="padding-top: 180px; padding-bottom: 80px;">

    {% if distress_banner %}
    <div class="distress-banner">
        <h3>üíú We're Here For You</h3>
        <p>It sounds like you may be going through a difficult time. Please know that support is available.</p>
        <p><a href="tel:988">Call or text 988</a> for immediate crisis support.</p>
    </div>
    {% endif %}

    {% if warning %}
    <div class="warning-message">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 8v4M12 16h.01" />
        </svg>
        {{ warning }}
    </div>
    {% endif %}

    <div class="chat-container" style="padding: 0;">
        <!-- Chat Header -->
        <div class="chat-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>{{ group_topic }}</h2>
                    <p style="font-size: 14px; opacity: 0.9; margin-top: 4px;">Group chat with peers</p>
                </div>
                <form method="POST" action="{{ url_for('leave_group') }}" style="margin: 0;">
                    <button type="submit"
                        style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px;">
                        Leave Group
                    </button>
                </form>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            {% if messages %}
            {% for msg in messages %}
            <div class="message {% if msg.user_id == current_user_id %}own{% else %}other{% endif %}"
                id="msg-{{ msg.id }}" data-message-id="{{ msg.id }}">
                <div class="message-header">
                    <span class="message-sender">{{ msg.display_name }}</span>
                    <span class="message-time">{{ msg.timestamp }}</span>
                </div>
                <div class="message-text" id="text-{{ msg.id }}">
                    {{ msg.text }}
                    {% if msg.edited %}<span class="edited-tag">(edited)</span>{% endif %}
                </div>
                {% if msg.user_id == current_user_id %}
                <div class="message-actions" id="actions-{{ msg.id }}">
                    <button onclick="editMessage('{{ msg.id }}')">Edit</button>
                    <button onclick="deleteMessage('{{ msg.id }}')">Delete</button>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div style="text-align: center; color: var(--text-secondary); padding: 60px 20px;">
                <p style="font-size: 48px; margin-bottom: 16px;">üí¨</p>
                <p>No messages yet. Be the first to say hello!</p>
            </div>
            {% endif %}
        </div>

        <!-- Chat Input -->
        <form method="POST" action="{{ url_for('chat') }}" class="chat-input-container">
            <input type="text" name="message_text" placeholder="Type your message..." required autocomplete="off">
            <button type="submit">Send</button>
        </form>
    </div>

    <!-- Back to Dashboard -->
    <div style="margin-top: 24px;">
        <a href="{{ url_for('decision') }}" class="btn btn-outline">‚Üê Back to Dashboard</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Scroll to bottom of messages
    const container = document.getElementById('messagesContainer');
    if (container) {
        container.scrollTop = container.scrollHeight;
    }

    // Auto-refresh messages every 5 seconds
    setInterval(function () {
        // Could implement AJAX polling here for real-time updates
    }, 5000);

    // Edit Message
    function editMessage(msgId) {
        const textEl = document.getElementById('text-' + msgId);
        const actionsEl = document.getElementById('actions-' + msgId);
        const currentText = textEl.textContent.replace('(edited)', '').trim();

        // Replace text with input
        textEl.innerHTML = `
            <input type="text" id="edit-input-${msgId}" value="${currentText}" style="width: 100%; padding: 8px; border: 1px solid var(--border-gray); border-radius: 8px;">
        `;

        // Replace actions with save/cancel
        actionsEl.innerHTML = `
            <button onclick="saveEdit('${msgId}')">Save</button>
            <button onclick="cancelEdit('${msgId}', '${encodeURIComponent(currentText)}')">Cancel</button>
        `;

        document.getElementById('edit-input-' + msgId).focus();
    }

    function saveEdit(msgId) {
        const input = document.getElementById('edit-input-' + msgId);
        const newText = input.value.trim();

        if (!newText) return;

        fetch('/api/message/edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message_id: msgId, text: newText })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Failed to edit message');
                    location.reload();
                }
            })
            .catch(() => location.reload());
    }

    function cancelEdit(msgId, originalText) {
        location.reload();
    }

    // Delete Message
    function deleteMessage(msgId) {
        if (!confirm('Are you sure you want to delete this message?')) return;

        fetch('/api/message/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message_id: msgId })
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('msg-' + msgId).remove();
                } else {
                    alert(data.error || 'Failed to delete message');
                }
            })
            .catch(() => alert('Error deleting message'));
    }
</script>
{% endblock %}